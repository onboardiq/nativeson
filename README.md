# Nativeson

ActiveRecord methods to generate JSON from database records using database-native functions
faster and with a smaller memory footprint on your web server.

Nativeson helps you create the SQL query format needed to fetch a ready JSON to be sent to
your front-end.

Nativeson doesn't replace serializers completely, since serializers use ActiveRecord objects
that you can process through some business logic before you generate a JSON from them.

Nativeson fits when a SQL query (WHERE/SORT/ORDER/etc.) is sufficient and the
database response can be sent to the front-end.

## Requirements

PostgreSQL 9.2 or higher.

## Usage

Include the Nativeson module either in the particular ActiveRecord model class(es) you want its functionality in, or to make it globally available to all your models, include it in your Rails app's ApplicationRecord class, or for apps generated by older versions of Rails that don't have ApplicationRecord (or if you have some other reason to do so), into ActiveRecord::Base.

```ruby
class User < ApplicationRecord # or ActiveRecord::Base in older apps
  include Nativeson
end
```
OR
```ruby
class ApplicationRecord < ActiveRecord::Base
  include Nativeson
end
```
OR
```ruby
# monkey-patching via a file in config/initializers:
module ActiveRecord
  class Base
    include Nativeson
  end
end
```

## Installation
Add this line to your application's Gemfile:

```ruby
gem 'nativeson'
```

And then execute:
```bash
$ bundle
```

Or install it yourself as:
```bash
$ gem install nativeson
```

## Benchmarks

We compared Nativeson to `ActiveModel::Serializer` and to [Panko](https://github.com/yosiat/panko_serializer)
It's important to note that both rely on `ActiveRecord` to fetch the data for them.
This makes a huge difference in the benchmarks.
In "regular" flow, such as `Panko` and `ActiveModel::Serializer`.
The cycle is:
* `request`
* `DB query`
* `ActiveRecord`
* `Panko` or `ActiveModel::Serializer` serialization.
* `JSON response`

With Nativeson the cycle is much shorter:
* `request`
* `DB query`
* `JSON response`

Due to the above there are a few important items to take into account:
* Nativeson should be used when your SQL query is sufficient and contains all
  the logic you need to create your response.
  If you need to query the DB and then do complex processing on `Ruby` side,
  than Nativeson might not fit your needs.
* When comparing, we compared to how long it takes with/without the `ActiveRecord`
  stage. We believe this stage should be taken into account since in reality the cycle
  time will include it.
  
  
Benchmark links:  

<table>
  <thead>
    <tr>
      <th>Data Size</th>
      <th>ActiveRecord</th>
      <th>Associations</th>
      <th>AMS ips</th>
      <th>Panko ips</th>
      <th>Nativeson ips</th>
      <th>Comments</th>
      <th>Link</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>4813</td>
      <td><b>47718</b></td>
      <td>2429</td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_no_associations/excluding_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>
    <tr>
      <td>202</td>
      <td>No</td>
      <td>No</td>
      <td>44</td>
      <td><b>728</b></td>
      <td>510</td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_no_associations/excluding_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>
    <tr>
      <td>403</td>
      <td>No</td>
      <td>No</td>
      <td>26</td>
      <td><b>359</b></td>
      <td>349</td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_no_associations/excluding_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>
    <tr>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>989</td>
      <td>1584</td>
      <td><b>2341</b></td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_no_associations/including_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>    
    <tr>
      <td>202</td>
      <td>Yes</td>
      <td>No</td>
      <td>21</td>
      <td>189</td>
      <td><b>550</b></td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_no_associations/including_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>    
    <tr>
      <td>403</td>
      <td>Yes</td>
      <td>No</td>
      <td>11</td>
      <td>112</td>
      <td><b>295</b></td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_no_associations/including_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>     
    <tr>
      <td>1</td>
      <td>No</td>
      <td>Yes</td>
      <td>126</td>
      <td><b>621</b></td>
      <td>237</td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_all_associations/excluding_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>
    <tr>
      <td>202</td>
      <td>No</td>
      <td>Yes</td>
      <td>3</td>
      <td><b>33</b></td>
      <td>14</td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_all_associations/excluding_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>       
    <tr>
      <td>403</td>
      <td>No</td>
      <td>Yes</td>
      <td>2</td>
      <td><b>32</b></td>
      <td>13</td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_all_associations/excluding_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>     
    <tr>
      <td>1</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>31</td>
      <td>50</td>
      <td><b>238</b></td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_all_associations/including_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>     
    <tr>
      <td>202</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>1.1</td>
      <td>3.4</td>
      <td><b>15.2</b></td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_all_associations/including_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>
    <tr>
      <td>403</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>1.0</td>
      <td>3.0</td>
      <td><b>12.6</b></td>
      <td>Comments</td>
      <td>
        <a href='dummy/test/benchmarks/users_all_associations/including_active_records/benchmark.rb'>
          benchmark
        </a>
      </td>
    </tr>      
  </tbody>
</table>

## Contributing
Contribution directions go here.

## License
The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
